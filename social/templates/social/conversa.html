{% extends "account/base.html" %}
{% load i18n tz %}

{% block title %}Conversa com {{ outro_usuario.username }}{% endblock %}

{% block extra_head %}
    {% load static %}
<link rel="stylesheet" href="{% static 'css/login/conversa.css' %}">

{% endblock %}





{% block content %}



<div class="container my-5">
    <div class="card">
        <div class="card-header">
            <h3>Conversa com {{ outro_usuario.username }}</h3>
        </div>
        <div id="chat-log" class="card-body">
            {% for mensagem in mensagens %}
                <div class="d-flex mb-2 message-row {% if mensagem.remetente == request.user %}flex-row-reverse{% endif %}">
                    <img src="{{ mensagem.remetente.perfil.foto.url }}" class="rounded-circle mx-2" width="40" height="40" style="object-fit: cover;">
                    <div class="d-inline-block p-2 rounded-3 {% if mensagem.remetente == request.user %}bg-primary text-white{% else %}bg-light text-dark{% endif %}">
                        <small class="d-block {% if mensagem.remetente != request.user %}fw-bold{% endif %}">{{ mensagem.remetente.username }}</small>
                        {{ mensagem.conteudo }}
                        <small class="d-block text-end mt-1" style="font-size: 0.7rem;">{{ mensagem.timestamp|localtime|date:"H:i" }}</small>
                    </div>
                </div>
            {% endfor %}
        </div>
        <div class="card-footer">
            <form id="chat-form" class="d-flex">
                <input type="text" id="chat-message-input" class="form-control me-2" placeholder="Digite a sua mensagem..." autocomplete="off">
                <button type="submit" class="btn btn-primary">Enviar</button>
            </form>
        </div>
    </div>
</div>

{{ outro_usuario.username|json_script:"json-outro-usuario-username" }}
{{ request.user.username|json_script:"json-meu-usuario-username" }}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const outroUsuarioUsername = JSON.parse(document.getElementById('json-outro-usuario-username').textContent);
        const meuUsuarioUsername = JSON.parse(document.getElementById('json-meu-usuario-username').textContent);
        const chatLog = document.querySelector('#chat-log');
        const messageInput = document.querySelector('#chat-message-input');
        const chatForm = document.querySelector('#chat-form');

        function scrollToBottom() {
            chatLog.scrollTop = chatLog.scrollHeight;
        }
        scrollToBottom();

        const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + outroUsuarioUsername + '/');

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);

            if (data.type === 'chat_message') {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('d-flex', 'mb-2', 'message-row');
                if (data.username === meuUsuarioUsername) {
                    messageDiv.classList.add('flex-row-reverse');
                }
                const avatarImg = `<img src="${data.user_avatar_url}" class="rounded-circle mx-2" width="40" height="40" style="object-fit: cover;">`;
                messageDiv.innerHTML = `
                    ${avatarImg}
                    <div class="d-inline-block p-2 rounded-3 ${data.username === meuUsuarioUsername ? 'bg-primary text-white' : 'bg-light text-dark'}">
                        <small class="d-block ${data.username !== meuUsuarioUsername ? 'fw-bold' : ''}">${data.username}</small>
                        ${data.message}
                        <small class="d-block text-end mt-1" style="font-size: 0.7rem;">${data.timestamp}</small>
                    </div>
                `;
                chatLog.appendChild(messageDiv);
                scrollToBottom();
            }
        };

        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const message = messageInput.value;
            if (message.trim() !== '') {
                chatSocket.send(JSON.stringify({'message': message}));
                messageInput.value = '';
            }
        });
    });
</script>
{% endblock %}